<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Learn Me a Database ‚ûî Todos with Cross-Off</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 70%;
      margin: 2em auto;
      padding: 0 1em;
	  font-size: 14px;
    }
    h1, h2 {
      text-align: center;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    #controls>* {
      flex: 1;
      min-width: 100px;
    }
    #new-item { flex: 2 1 200px; }
    ul {
      list-style: none;
      padding: 0;
      margin-bottom: 1em;
    }
    li {
      background: #f9f9f9;
      margin: .5em 0;
      padding: .75em;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    li.done span.content {
      text-decoration: line-through;
      color: #888;
    }
    .btns button {
      margin-left: .25em;
    }
    pre#sql-console {
      background: #f4f4f4;
      border: 1px solid #ccc;
      padding: 1em;
      height: 200px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
</head>
<body>
  <h1>üìù Database Learnin with AK</h1>
  <h2>the quintessential todolist</h2>

  <div id="controls">
    <button id="open-db">Choose Folder...</button>
    <input id="new-item" type="text" placeholder="New todo item‚Ä¶" disabled>
    <button id="add-item" disabled>Add</button>
    <button id="clear-console" disabled>Clear Console</button>
  </div>

  <ul id="todo-list"></ul>

  <h2>SQL Console</h2>
  <pre id="sql-console"></pre>

  <script>
    let SQL, db, dirHandle, fileHandle;

    // 1) Load SQL.js
    initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${f}` })
      .then(lib => { SQL = lib; })
      .catch(err => console.error("Failed to load SQL.js:", err));

    // 2) Exec+persist helper
    async function execAndPersist(sql, params = []) {
      document.getElementById('sql-console').textContent += `> ${sql} ${JSON.stringify(params)}\n`;
      db.run(sql, params);
      const data = db.export();
      const blob = new Blob([data], { type: 'application/x-sqlite3' });
      const w = await fileHandle.createWritable();
      await w.write(blob);
      await w.close();
      renderList();
    }

    // 3) Render
    function renderList() {
      const out = document.getElementById('todo-list');
      out.innerHTML = '';
      const res = db.exec("SELECT id, content, done FROM todos ORDER BY position");
      if (!res[0]) return;
      for (const [id, content, done] of res[0].values) {
        const li = document.createElement('li');
        if (done) li.classList.add('done');

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!done;
        chk.onchange = () => execAndPersist(
          "UPDATE todos SET done = ? WHERE id = ?",
          [chk.checked ? 1 : 0, id]
        );

        const txt = document.createElement('span');
        txt.className = 'content';
        txt.textContent = content;

        const btns = document.createElement('span');
        btns.className = 'btns';

        // up
        const up = document.createElement('button');
        up.textContent = '‚Üë';
        up.onclick = async () => {
          const [[pos]] = db.exec("SELECT position FROM todos WHERE id = ?", [id])[0].values;
          const above = db.exec(
            "SELECT id, position FROM todos WHERE position < ? ORDER BY position DESC LIMIT 1",
            [pos]
          );
          if (!above[0]) return;
          const [bId, bPos] = above[0].values[0];
          await execAndPersist(
            `UPDATE todos SET position = CASE id
               WHEN ? THEN ?
               WHEN ? THEN ?
             END
             WHERE id IN (?, ?)`,
            [id, bPos, bId, pos, id, bId]
          );
        };

        // down
        const down = document.createElement('button');
        down.textContent = '‚Üì';
        down.onclick = async () => {
          const [[pos]] = db.exec("SELECT position FROM todos WHERE id = ?", [id])[0].values;
          const below = db.exec(
            "SELECT id, position FROM todos WHERE position > ? ORDER BY position ASC LIMIT 1",
            [pos]
          );
          if (!below[0]) return;
          const [bId, bPos] = below[0].values[0];
          await execAndPersist(
            `UPDATE todos SET position = CASE id
               WHEN ? THEN ?
               WHEN ? THEN ?
             END
             WHERE id IN (?, ?)`,
            [id, bPos, bId, pos, id, bId]
          );
        };

        // delete
        const del = document.createElement('button');
        del.textContent = '‚úï';
        del.onclick = () => execAndPersist("DELETE FROM todos WHERE id = ?", [id]);

        btns.append(up, down, del);
        li.append(chk, txt, btns);
        out.append(li);
      }
    }

    // 4) Add
    async function addItem(text) {
      if (!text.trim()) return;
      const [[maxPos]] = db.exec("SELECT COALESCE(MAX(position),0) FROM todos")[0].values;
      await execAndPersist(
        "INSERT INTO todos (content, position, done) VALUES (?, ?, ?)",
        [text, maxPos + 1, 0]
      );
      document.getElementById('new-item').value = '';
    }

    // 5) Open/Create & migrate/seed
    async function openDatabase() {
      dirHandle   = await window.showDirectoryPicker();
      fileHandle  = await dirHandle.getFileHandle('database.sqlite', { create: true });
      const file   = await fileHandle.getFile();
      const u8     = new Uint8Array(await file.arrayBuffer());
      db = new SQL.Database(u8);

      // Check if todos table exists
      const tables = db.exec(
        "SELECT name FROM sqlite_master WHERE type='table' AND name='todos';"
      );
      if (!tables[0]) {
        // create table with done
        await execAndPersist(
          `CREATE TABLE todos (
             id INTEGER PRIMARY KEY AUTOINCREMENT,
             content TEXT NOT NULL,
             position INTEGER NOT NULL,
             done INTEGER NOT NULL DEFAULT 0
           );`
        );
        // seed
        const seed = [
          "Summon printer dragon","Warp TPS reports","Pet the quantum stapler",
          "Feed coffee to the server","Negotiate with office cactus",
          "Teleport chair to Mars","Encrypt snack signals",
          "Chase rogue spreadsheet","Debug existential crisis",
          "Train squirrels as interns"
        ];
        for (let i = 0; i < seed.length; i++) {
          await execAndPersist(
            "INSERT INTO todos (content, position, done) VALUES (?, ?, ?)",
            [seed[i], i+1, 0]
          );
        }
      } else {
        // table exists ‚Üí ensure done column
        const cols = db.exec("PRAGMA table_info(todos);")[0].values.map(r => r[1]);
        if (!cols.includes('done')) {
          await execAndPersist(
            "ALTER TABLE todos ADD COLUMN done INTEGER NOT NULL DEFAULT 0"
          );
        }
      }

      document.getElementById('new-item').disabled      = false;
      document.getElementById('add-item').disabled      = false;
      document.getElementById('clear-console').disabled = false;
      renderList();
    }

    // 6) Clear console
    document.getElementById('clear-console').onclick = () => {
      document.getElementById('sql-console').textContent = '';
    };

    // 7) Wire UI
    document.getElementById('open-db').onclick  = openDatabase;
    document.getElementById('add-item').onclick = () =>
      addItem(document.getElementById('new-item').value);
    document.getElementById('new-item')
      .addEventListener('keydown', e => { if (e.key === 'Enter') addItem(e.target.value); });
  </script>
</body>
</html>
